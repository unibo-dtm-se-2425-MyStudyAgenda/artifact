name: CI
on:
  push:
    paths-ignore:
      - '.gitignore'
      - 'CHANGELOG.md'
      - 'LICENSE'
      - 'README.md'
  pull_request:
  workflow_dispatch:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        python-version:
          - '>=3.13'
    runs-on: ${{ matrix.os }}
    name: Test on Python ${{ matrix.python-version }}, on ${{ matrix.os }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-root

      # Configure environment variables used by tests
      - name: Prepare environment variables
        shell: bash
        run: |
          echo "Preparing environment variables on $RUNNER_OS"
          echo "PYTHONPATH=." >> $GITHUB_ENV
          echo "KIVY_NO_ARGS=1" >> $GITHUB_ENV
          echo "KIVY_NO_CONSOLELOG=1" >> $GITHUB_ENV
          echo "KIVY_METRICS_DENSITY=1" >> $GITHUB_ENV
          echo "KIVY_DPI=96" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          # Prefer safe providers for headless macOS/Windows
          if [ "$RUNNER_OS" != "Linux" ]; then
            echo "KIVY_WINDOW=mock" >> $GITHUB_ENV
            echo "KIVY_GL_BACKEND=mock" >> $GITHUB_ENV
            echo "KIVY_IMAGE=pil,imageio" >> $GITHUB_ENV
            echo "KIVY_TEXT=pil" >> $GITHUB_ENV
            # Also force provider order to exclude sdl2 where possible
            echo "KIVY_WINDOW_PROVIDER=mock" >> $GITHUB_ENV
          fi

      - name: Run tests (Linux under Xvfb; macOS/Windows headless)
        shell: bash
        run: |
          set -e
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "Installing Xvfb and running full test suite (including UI)"
            sudo apt-get update
            sudo apt-get install -y xvfb
            # export flag to enable UI tests
            export RUN_UI_TESTS=1
            xvfb-run -a -s "-screen 0 1920x1080x24" poetry run pytest --maxfail=1 --disable-warnings
          else
            echo "Running Kivy UI tests headlessly on $RUNNER_OS (mock window)"
            export RUN_UI_TESTS=0
            poetry run pytest --maxfail=1 --disable-warnings
          fi